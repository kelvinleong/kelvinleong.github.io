<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->


<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>Download Secure Data with Request</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon.ico" />

    <!-- Come and get me RSS readers -->
    <link rel="alternate" type="application/rss+xml" title="Kelvin" href="127.0.0.1/feed.xml" />
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <!--[if IE 8]><link rel="stylesheet" href="/assets/css/ie.css"><![endif]-->
    <link rel="canonical" href="127.0.0.1/python/2016/08/19/Download-Secure-Data.html">

    <!-- Modernizr -->
    <script src="/assets/js/modernizr.custom.15390.js" type="text/javascript"></script>

     <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-78047723-1', 'auto');
ga('send', 'pageview');

</script>
 

    
</head>


<body>

    <div class="header">
     <div class="container">
         <h1 class="logo"><a href="/">Kelvin</a></h1>
         <nav class="nav-collapse">
             <ul class="noList">
                 
                 <li class="element first  ">
                     <a href="/index.html">Home</a>
                 </li> 
                 
                 <li class="element   ">
                     <a href="/about.html">About</a>
                 </li> 
                 
                 <li class="element   last">
                     <a href="/contact.html">Contact</a>
                 </li> 
                 
                 <li> <a href="https://github.com/brianmaierjr/long-haul" target="_blank">GitHub</a></li>
                 <li><a href="https://github.com/brianmaierjr/long-haul/archive/master.zip">Download Theme</a></li>
             </ul>
         </nav>
     </div>
 </div><!-- end .header -->


   <div class="content">
      <div class="sidebar">
        <div class="widget-wrapper">
<h3 class="widget-title">Archive</h3>
<ul>

    
    
        <li><a href="/archive.html#August2016">August 2016</a></li>
        
    

    
    
        <li><a href="/archive.html#July2016">July 2016</a></li>
        
    

    
    
        <li><a href="/archive.html#June2016">June 2016</a></li>
        
    

    
    

    
    
        <li><a href="/archive.html#May2016">May 2016</a></li>
        
    

    
    

    
    
        <li><a href="/archive.html#March2016">March 2016</a></li>
        
    

    
    
        <li><a href="/archive.html#December2015">December 2015</a></li>
        
    

    
    
        <li><a href="/archive.html#November2015">November 2015</a></li>
        
    

    
    

    
    

    
    
        <li><a href="/archive.html#October2015">October 2015</a></li>
        
    

    
    
        <li><a href="/archive.html#September2015">September 2015</a></li>
        
    

    
    

    
    
        <li><a href="/archive.html#August2015">August 2015</a></li>
        
    

    
    

    
    

    
    

    
    

</ul>
</div>

<div class="widget-wrapper">
<h3 class="widget-title">Categories</h3>
<ul>
  
    
     <li><a href="/categories.html#Theme-ref">
     Theme</span>
     </a></li>
    
     <li><a href="/categories.html#Database-ref">
     Database</span>
     </a></li>
    
     <li><a href="/categories.html#Java-ref">
     Java</span>
     </a></li>
    
     <li><a href="/categories.html#Encoding-ref">
     Encoding</span>
     </a></li>
    
     <li><a href="/categories.html#PDF-ref">
     PDF</span>
     </a></li>
    
     <li><a href="/categories.html#JVM-ref">
     JVM</span>
     </a></li>
    
     <li><a href="/categories.html#Oracle-ref">
     Oracle</span>
     </a></li>
    
     <li><a href="/categories.html#Multithreading-ref">
     Multithreading</span>
     </a></li>
    
     <li><a href="/categories.html#Google-ref">
     Google</span>
     </a></li>
    
     <li><a href="/categories.html#Python-ref">
     Python</span>
     </a></li>
    
  
</ul>
</div>

      </div>
      <div class="container">
          <div class="post">
  
  <h1 class="postTitle">Download Secure Data with Request</h1>
  <p class="meta">August 19, 2016 | <span class="time">3</span> Minute Read</p>

  <p>In the previous post, I have introduce how to auto login to the HSBC website using python. But my final purpose is to download the eStatements of my credit card and saving accounts monthly. So in the post I’ll introduce the steps to auto download the eStatements.</p>

<p>The first step is to find out the route to the page where the eStatements could be viewed.</p>

<p>It can be easily found that eStatements view page could be accessed under “Card” tab –&gt; eStatements and service link. Therefore, after login to the online banking account. To implement the mentioned steps, it could be done by the following codes.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="c"># route to Card tab page</span>
   <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"https://www1.personal.ebanking.hsbc.com.hk/1/3/cards?__cmd-All_MenuRefresh="</span><span class="p">)</span>

   <span class="c"># click e-Statement hyperlink</span>
   <span class="n">link</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="s">"//a[@href='https://www1.personal.ebanking.hsbc.com.hk/1/3/my-hsbc/estatement?cmd-ECorrespDummyPortlet_in=&amp;designateType=Card']"</span><span class="p">)</span>
   <span class="n">link</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
</code></pre>
</div>

<p>Next, we have to find out the source download address of these pdf files so that we can save it to the local file. After several trials, I found that there is no easy way to get the source address. The address is embedded in new open window which is triggered by some javascript codes and will be changed each time. So my solution is to open the pdf file and then grep the source address in the page source by the following codes:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># switch to new open window</span>
   <span class="n">new_win</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">window_handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
   <span class="n">driver</span><span class="o">.</span><span class="n">switch_to</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">new_win</span><span class="p">)</span>

   <span class="c"># print(driver.page_source)</span>
   <span class="n">pdf_file</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s">"iframe"</span><span class="p">)</span>
   <span class="n">path</span> <span class="o">=</span> <span class="n">pdf_file</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s">"src"</span><span class="p">)</span>
</code></pre>
</div>

<p>However, even though we can get the source address it does not mean that we can call some selenium api so that it will download the file for us. Because Selenium <strong><em>doest not</em></strong> support the download feature. Therefore, I switch to another open lib for help i.e., request.</p>

<h3 id="what-is-request">what is Request?</h3>

<blockquote>
  <p>Requests is an elegant and simple HTTP library for Python, built for human beings. You are currently looking at the documentation of the development release.</p>
</blockquote>

<p>You can find more tutorial and introductions in <a href="http://docs.python-requests.org/en/master/user/quickstart/">Request</a>.</p>

<p>We can get the e-Statements source content by using request get method and then write it to the local file by triggering file write method. But there is still one problem, that is we have to obtain the secure session so that we can proceed the download action. This would be done by injecting the cookies data retrieved via Selenium’s get_cookie() to the request session. The following codes show you how to do it.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"User-Agent"</span><span class="p">:</span>
            <span class="s">"Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.157 Safari/537.36"</span>
    <span class="p">}</span>
    <span class="n">s</span><span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

    <span class="n">cookies</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">get_cookies</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cookie</span> <span class="ow">in</span> <span class="n">driver</span><span class="o">.</span><span class="n">get_cookies</span><span class="p">():</span>
        <span class="c"># c = {cookie['name']: cookie['value']}</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">cookie</span><span class="p">[</span><span class="s">'name'</span><span class="p">],</span> <span class="n">cookie</span><span class="p">[</span><span class="s">'value'</span><span class="p">])</span>

    <span class="n">local_filename</span> <span class="o">=</span> <span class="s">"/Users/kelvinleung/Downloads/Test/Test_Args/"</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">".pdf"</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">local_filename</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</code></pre>
</div>

<p>By the way, it’s better to use a fake header to cheat the HSBC server as it may discard the request  without header information to prevent attack.</p>


  <!-- POST NAVIGATION -->
  <div class="postNav clearfix">
    
      <a class="prev" href="/python/2016/07/19/Scrape-Bank-Account.html"><span>&laquo;&nbsp;Auto Login Bank Account using Python</span>
      
    </a>
    
    
  </div>
</div>

      </div>
   </div><!-- end .content -->

   <div class="footer">
   <div class="container">
      <p class="copy">&copy; 2016 <a href="">Kelvin Liang</a> Powered by <a href="http://jekyllrb.com">Jekyll</a></p>

      <div class="footer-links">
         <ul class="noList">
            
            <li><a href="https://www.facebook.com/kelvin.Y.H.Leung">
                  <svg id="facebook-square" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M82.667,1H17.335C8.351,1,1,8.351,1,17.336v65.329c0,8.99,7.351,16.335,16.334,16.335h65.332 C91.652,99.001,99,91.655,99,82.665V17.337C99,8.353,91.652,1.001,82.667,1L82.667,1z M84.318,50H68.375v42.875H50V50h-8.855V35.973 H50v-9.11c0-12.378,5.339-19.739,19.894-19.739h16.772V22.3H72.967c-4.066-0.007-4.57,2.12-4.57,6.078l-0.023,7.594H86.75 l-2.431,14.027V50z"></path>
                  </svg>
            </a></li>
            
            
            
            <li><a href="https://github.com/kelvinleong">
                  <svg id="github" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M79.099,79.099 c-3.782,3.782-8.184,6.75-13.083,8.823c-1.245,0.526-2.509,0.989-3.79,1.387v-7.344c0-3.86-1.324-6.699-3.972-8.517 c1.659-0.16,3.182-0.383,4.57-0.67c1.388-0.287,2.855-0.702,4.402-1.245c1.547-0.543,2.935-1.189,4.163-1.938 c1.228-0.75,2.409-1.723,3.541-2.919s2.082-2.552,2.847-4.067s1.372-3.334,1.818-5.455c0.446-2.121,0.67-4.458,0.67-7.01 c0-4.945-1.611-9.155-4.833-12.633c1.467-3.828,1.308-7.991-0.478-12.489l-1.197-0.143c-0.829-0.096-2.321,0.255-4.474,1.053 c-2.153,0.798-4.57,2.105-7.249,3.924c-3.797-1.053-7.736-1.579-11.82-1.579c-4.115,0-8.039,0.526-11.772,1.579 c-1.69-1.149-3.294-2.097-4.809-2.847c-1.515-0.75-2.727-1.26-3.637-1.532c-0.909-0.271-1.754-0.439-2.536-0.503 c-0.782-0.064-1.284-0.079-1.507-0.048c-0.223,0.031-0.383,0.064-0.478,0.096c-1.787,4.53-1.946,8.694-0.478,12.489 c-3.222,3.477-4.833,7.688-4.833,12.633c0,2.552,0.223,4.889,0.67,7.01c0.447,2.121,1.053,3.94,1.818,5.455 c0.765,1.515,1.715,2.871,2.847,4.067s2.313,2.169,3.541,2.919c1.228,0.751,2.616,1.396,4.163,1.938 c1.547,0.543,3.014,0.957,4.402,1.245c1.388,0.287,2.911,0.511,4.57,0.67c-2.616,1.787-3.924,4.626-3.924,8.517v7.487 c-1.445-0.43-2.869-0.938-4.268-1.53c-4.899-2.073-9.301-5.041-13.083-8.823c-3.782-3.782-6.75-8.184-8.823-13.083 C9.934,60.948,8.847,55.56,8.847,50s1.087-10.948,3.231-16.016c2.073-4.899,5.041-9.301,8.823-13.083s8.184-6.75,13.083-8.823 C39.052,9.934,44.44,8.847,50,8.847s10.948,1.087,16.016,3.231c4.9,2.073,9.301,5.041,13.083,8.823 c3.782,3.782,6.75,8.184,8.823,13.083c2.143,5.069,3.23,10.457,3.23,16.016s-1.087,10.948-3.231,16.016 C85.848,70.915,82.88,75.317,79.099,79.099L79.099,79.099z"></path>
                  </svg>
            </a></li>
            
            
         </ul>
      </div>
   </div>
</div><!-- end .footer -->

   <!-- Add jQuery and other scripts -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src=""><\/script>')</script>
<script src="/assets/js/dropcap.min.js"></script>
<script src="/assets/js/responsive-nav.min.js"></script>
<script src="/assets/js/scripts.js"></script>
<link rel="stylesheet" href="/assets/js/plugins/prettify.css">
<script src="/assets/js/plugins/prettify.js"></script>
<script type="text/javascript">
  $(function(){
    $("pre").addClass("prettyprint");
    prettyPrint();
  });
</script>


</body>

</html>
